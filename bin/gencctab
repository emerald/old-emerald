#!/usr/bin/env bash
#
# Generate the tables and lists that drive the ccalls mechanism

set -euo pipefail

allfiles=$(\
  cd "${EMERALDROOT}/ccalls" ; \
  emmake doths | egrep -v 'Entering|Leaving')

selectedfiles=$(echo $* | sed -e 's/\.o/\.h/g')

ncctabh=cctab.h
ncctabc=cctab.c

mndx=0

cp /dev/null $ncctabh
cp /dev/null $ncctabc

cat << THEEND >> $ncctabh
/*
 * $ncctabh
 *
 * THIS FILE IS AUTOMATICALLY GENERATED.  DO NOT EDIT.
 */

#ifndef _EMERALD_CCALLTAB_H
#define _EMERALD_CCALLTAB_H 1

typedef int (*ccallFunction)(void);

typedef struct CCallDescriptor {
  ccallFunction ccFunction;
  char* ccName;
  char* ccArgTemplate;
} CCallDescriptor;

extern CCallDescriptor *ccalltable[];
THEEND

cat << THEEND >> $ncctabc
/*
 * $ncctabc
 *
 * THIS FILE IS AUTOMATICALLY GENERATED.  DO NOT EDIT.
 */

#define E_NEEDS_STDIO_ONLY
#include "system.h"
#include "assert.h"
#include "$ncctabh"

THEEND

getModulename() {
  echo "${1%.*}" | tr a-z A-Z
}

isSelected() {
  file=$1
  selected=""
  for selectedfile in $selectedfiles
  do
    if [ "$selectedfile" == "$file" ]; then
      selected="1"
    fi
  done
  test "$selected"
}

for file in $allfiles
do
  absfile="$EMERALDROOT/ccalls/$file"
  mname="$(getModulename "${file}")"

  if isSelected "${file}"; then
    printf "Generating %s\n" $mname
  else
    printf "Skipping %s\n" $mname
    continue
  fi

  printf "%s\n" "#define ${mname} $mndx" >> $ncctabh
  printf "%s\n" "CCallDescriptor ${mname}_table[] = {" >> $ncctabc

  ccss=$(grep '^CCALL' $absfile | sed \
      -e 's/CCALL *( *//' \
      -e 's/,/ /g' \
      -e 's/)//' \
      -e 's/"//g' \
      -e 's/;//' \
      -e 's/\015//')

  fndx=0
  if [ $(echo "$ccss" | wc -l) -eq 0 ]; then
    printf "%s\n" \
      "  { (ccallFunction) notselected, \"\", \"\" }," \
      >> $ncctabc
  else
    while read css; do
      read -r -a cs <<< "$css"
      fname=${cs[0]}
      ccname=${cs[1]}
      ccstring=${cs[2]}
      if [ $selected ]; then
        printf "%s\n" "extern int $fname(void);" >> $ncctabh
        printf "%s\n" \
          "  { (ccallFunction) $fname, \"$ccname\", \"$ccstring\" }," \
          >> $ncctabc
      else
        printf "%s\n" \
          "  { (ccallFunction) notselected, \"$ccname\", \"$ccstring\" }," \
          >> $ncctabc
      fi
      printf "%s\n" "#define ${ccname} $fndx" >> $ncctabh
      fndx=$((fndx+1))
    done <<<"$ccss"
  fi
  printf "%s\n" "};" >> $ncctabc
  mndx=$((mndx+1))
done

printf "%s\n" "CCallDescriptor *ccalltable[] = {" >> $ncctabc
for file in $allfiles
do
  if isSelected "${file}"; then
    mname="$(getModulename "${file}")"
    printf "%s\n" "  ${mname}_table," >> $ncctabc
  else
    printf "%s\n" "  0," >> $ncctabc
  fi
done
printf "%s\n" "#endif" >> $ncctabh
printf "%s\n" "};" >> $ncctabc
